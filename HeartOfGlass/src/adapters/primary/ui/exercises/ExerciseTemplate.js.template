/**
 * ExerciseTemplate.js
 *
 * ğŸ“ TEMPLATE pour crÃ©er un nouvel exercice
 *
 * Ce fichier est un exemple commentÃ© montrant comment crÃ©er un exercice
 * suivant l'architecture hexagonale avec BaseExerciseAdapter.
 *
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ğŸ¯ INSTRUCTIONS:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *
 * 1. Copier ce fichier et renommer (ex: MonNouvelExercice.js)
 * 2. Remplacer "MonExercice" par votre nom d'exercice
 * 3. CrÃ©er config dans configs/
 * 4. CrÃ©er services nÃ©cessaires dans core/domain/services/
 * 5. CrÃ©er use case dans core/useCases/
 * 6. ImplÃ©menter les hooks
 * 7. Tester !
 *
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ğŸ“š Ressources:
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * - ARCHITECTURE-MODEL.md (guide complet)
 * - RotationContinueExercise.js (exemple rÃ©el)
 * - BaseExerciseAdapter.js (classe de base)
 *
 * Architecture : Adapters/Primary/UI/Exercises
 */

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const BaseExerciseAdapter = require('./BaseExerciseAdapter');

// ğŸ“¦ Configuration
const { exerciseConfig, audioSettings } = require('./configs/MonExerciceConfig');

// ğŸ”§ Services Domaine (crÃ©ez-les dans core/domain/services/)
const ExerciseStateManager = require('../../../../core/domain/services/ExerciseStateManager');
const BufferManager = require('../../../../core/domain/services/BufferManager');
const SensorAnalyzer = require('../../../../core/domain/services/SensorAnalyzer');
// ... autres services selon vos besoins

// ğŸ¯ Use Case (crÃ©ez-le dans core/useCases/)
const MonExerciceUseCase = require('../../../../core/useCases/MonExerciceUseCase');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASSE EXERCICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class MonExercice extends BaseExerciseAdapter {
  /**
   * Constructeur
   *
   * âš ï¸ IMPORTANT: Appeler super() avec tous les paramÃ¨tres
   */
  constructor({ audioOrchestrator, state, calibrationOrchestrator, audioUIController }) {
    super({
      name: 'Mon Exercice',  // ğŸ“ Nom de l'exercice
      duration: exerciseConfig.duration,  // â±ï¸ DurÃ©e en ms
      audioOrchestrator,
      state,
      calibrationOrchestrator,
      audioUIController,
      config: exerciseConfig,
      audioSettings: audioSettings
    });

    // ğŸ“Š Diagnostics (optionnel)
    this.snapDiagnostics = {
      enabled: true,
      lastRate: 1.0,
      snapCount: 0,
      snapThreshold: 0.15
    };

    console.log('[MonExercice] InitialisÃ© avec succÃ¨s');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ¯ HOOKS OBLIGATOIRES - Ã€ IMPLÃ‰MENTER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * 1ï¸âƒ£ Configure les services domaine
   *
   * CrÃ©ez et instanciez tous vos services ici.
   * Chaque service a UNE responsabilitÃ©.
   *
   * Exemples de services :
   * - BufferManager : gestion buffers
   * - SensorAnalyzer : calculs capteurs
   * - DirectionDetector : dÃ©tection direction
   * - PlaybackCalculator : calculs audio
   * - VolumeController : contrÃ´le volume
   * - ExerciseMetrics : statistiques
   */
  setupServices() {
    console.log('[MonExercice] Configuration services...');

    // Exemple: Service d'analyse capteurs
    this.sensorAnalyzer = new SensorAnalyzer(this.config);

    // Exemple: Service de gestion buffer
    this.bufferManager = new BufferManager(this.sensorAnalyzer, this.config);

    // TODO: Ajoutez vos services spÃ©cifiques
    // this.monService = new MonService(this.config);
  }

  /**
   * 2ï¸âƒ£ Configure le StateManager
   *
   * Le StateManager gÃ¨re l'Ã©tat de l'exercice de maniÃ¨re centralisÃ©e.
   * Il Ã©limine la duplication entre constructor et start().
   */
  setupStateManager() {
    console.log('[MonExercice] Configuration StateManager...');

    this.stateManager = new ExerciseStateManager(this.config);
  }

  /**
   * 3ï¸âƒ£ Configure le Use Case
   *
   * Le Use Case orchestre les services pour accomplir
   * les cas d'utilisation mÃ©tier.
   *
   * Un Use Case = Une fonctionnalitÃ© mÃ©tier
   */
  setupUseCase() {
    console.log('[MonExercice] Configuration Use Case...');

    this.monUseCase = new MonExerciceUseCase({
      sensorAnalyzer: this.sensorAnalyzer,
      bufferManager: this.bufferManager,
      // ... autres services
      config: this.config,
      calibrationOrchestrator: this.calibrationOrchestrator
    });
  }

  /**
   * 4ï¸âƒ£ Initialise l'Ã©tat de l'exercice
   *
   * DÃ©clarez toutes les propriÃ©tÃ©s d'Ã©tat puis
   * utilisez StateManager pour les initialiser.
   *
   * âš ï¸ IMPORTANT: DÃ©clarez AVANT d'appeler applyInitialState()
   */
  initializeState() {
    console.log('[MonExercice] Initialisation Ã©tat...');

    // ğŸ“‹ DÃ©claration des propriÃ©tÃ©s d'Ã©tat (initialisÃ©es Ã  null)
    this.lastAngles = null;
    this.lastTimestamp = null;
    this.velocityBuffer = null;
    this.averageVelocity = null;
    // ... autres propriÃ©tÃ©s selon vos besoins

    // âœ¨ Initialisation via StateManager
    this.stateManager.applyInitialState(this);
  }

  /**
   * 5ï¸âƒ£ Traite la mise Ã  jour du capteur
   *
   * C'est ici que vous dÃ©lÃ©guez au Use Case.
   * L'Adapter ne fait QUE du routing et de l'I/O.
   *
   * Pattern recommandÃ© :
   * 1. Extraire donnÃ©es
   * 2. Appeler Use Case
   * 3. Appliquer rÃ©sultats
   * 4. I/O (audio, UI)
   */
  handleUpdate(sensorData, position, now) {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. EXTRACTION DONNÃ‰ES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const angles = sensorData.angles || sensorData;
    const gyro = sensorData.gyro || { x: 0, y: 0, z: 0 };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. GESTION CAPTEUR GAUCHE (exemple volume)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (position === 'GAUCHE') {
      // TODO: Traiter capteur gauche si nÃ©cessaire
      return;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3. PREMIER Ã‰CHANTILLON
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (this.lastTimestamp === null) {
      this.lastTimestamp = now;
      this.lastAngles = { ...angles };
      return;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4. VALIDATION DT
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const dt = (now - this.lastTimestamp) / 1000;

    if (dt < 0.001 || dt > 1.0) {
      console.warn(`[MonExercice] dt aberrant: ${(dt * 1000).toFixed(0)}ms`);
      this.lastTimestamp = now;
      return;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5. DÃ‰LÃ‰GATION AU USE CASE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const result = this.monUseCase.execute({
      angles,
      gyro,
      now,
      dt,
      state: this._getState()
    });

    // Skip si demandÃ©
    if (result.shouldSkip) {
      return;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 6. APPLICATION RÃ‰SULTATS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    this._applyStateUpdates(result.stateUpdates);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 7. I/O - COMMANDES AUDIO
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (result.audioCommand) {
      this._sendAudioCommand(result.audioCommand);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 8. I/O - NOTIFICATION UI
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    this._notifyUI('EXERCISE_UPDATE', {
      velocity: result.velocity,
      // ... autres donnÃ©es UI
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 9. MISE Ã€ JOUR LAST
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    this.lastAngles = { ...angles };
    this.lastTimestamp = now;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ¨ HOOKS OPTIONNELS - Personnalisation
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Validation custom avant dÃ©marrage
   * @override
   */
  validateBeforeStart() {
    // Appeler validation de base
    if (!super.validateBeforeStart()) {
      return false;
    }

    // TODO: Ajoutez vos validations custom
    // Exemple: vÃ©rifier config spÃ©cifique
    if (!this.config.monParametreImportant) {
      console.error('[MonExercice] Configuration manquante');
      return false;
    }

    return true;
  }

  /**
   * Logs custom au dÃ©marrage
   * @override
   */
  logStart() {
    super.logStart();

    // TODO: Logs additionnels
    console.log(`[MonExercice] Configuration: ${JSON.stringify(this.config.monParam)}`);
  }

  /**
   * Cleanup custom Ã  l'arrÃªt
   * @override
   */
  cleanupOnStop() {
    // TODO: Cleanup spÃ©cifique
    // Exemple: sauvegarder donnÃ©es, libÃ©rer ressources
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“Š MÃ‰THODES OBLIGATOIRES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Obtient les statistiques de l'exercice
   * @required
   */
  getStats() {
    // DÃ©lÃ©guer au service de mÃ©triques si disponible
    if (this.exerciseMetrics) {
      return this.exerciseMetrics.calculateStats(
        this.rotationHistory,
        this.startTime,
        this.updateCount
      );
    }

    // Sinon, stats basiques
    return {
      name: this.name,
      duration: (Date.now() - this.startTime) / 1000,
      updateCount: this.updateCount,
      // ... autres stats
    };
  }

  /**
   * Obtient l'Ã©tat actuel pour le Use Case
   * @override
   */
  _getState() {
    return {
      velocityBuffer: this.velocityBuffer,
      averageVelocity: this.averageVelocity,
      lastAngles: this.lastAngles,
      // ... toutes les propriÃ©tÃ©s d'Ã©tat nÃ©cessaires
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ”Š I/O - MÃ‰THODES PRIVÃ‰ES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Envoie commande audio
   * @private
   */
  _sendAudioCommand(command) {
    if (!this.audioOrchestrator) {
      return;
    }

    const { rate, direction, context } = command;

    // TODO: DÃ©duplication si nÃ©cessaire
    // TODO: Logs diagnostiques

    // Envoyer commande
    this.audioOrchestrator.setPlaybackRate(rate);
    this.audioOrchestrator.setDirection(direction);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

module.exports = MonExercice;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‹ CHECKLIST IMPLÃ‰MENTATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Configuration:
// [ ] CrÃ©er configs/MonExerciceConfig.js
// [ ] DÃ©finir exerciseConfig et audioSettings
//
// Services Domaine:
// [ ] Identifier responsabilitÃ©s (voir ARCHITECTURE-MODEL.md)
// [ ] CrÃ©er services dans core/domain/services/
// [ ] Tests unitaires services
//
// Use Case:
// [ ] CrÃ©er use case dans core/useCases/
// [ ] ImplÃ©menter orchestration
// [ ] Tests use case
//
// Adapter:
// [ ] ImplÃ©menter hooks obligatoires
// [ ] ImplÃ©menter handleUpdate()
// [ ] ImplÃ©menter getStats()
// [ ] Tests adapter
//
// Tests:
// [ ] Tests unitaires âœ…
// [ ] Tests intÃ©gration âœ…
// [ ] Tests physiques capteurs âœ…
//
// Documentation:
// [ ] Commenter code
// [ ] Documenter APIs
// [ ] README
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
